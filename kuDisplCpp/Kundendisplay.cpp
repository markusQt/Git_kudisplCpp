#include "Kundendisplay.h"
 void Kundendisplay::doSlideShow(std::vector<std::string> listeBilder,SDL_Rect destRect, SDL_Renderer *renderer){

    std::cout << "Thread wird aufgerufen!!"<<std::endl;

    for (int i = 0 ; i <= listeBilder.size()-1;i++){
        std::cout << "Thread: "<<listeBilder.at(i)<<std::endl;
        SDL_Texture *tmpPlayerTex= Texturemanager::loadTexture(listeBilder.at(i).c_str(),renderer);
        SDL_RenderClear(renderer);
        SDL_RenderCopy(renderer,tmpPlayerTex,NULL,&destRect);
        SDL_RenderPresent(renderer);
        SDL_Delay(3000);
        }


}

void Kundendisplay::doFilmShow(std::vector<std::string> listeFilme,SDL_Rect destRect, SDL_Renderer *renderer){

   for (int i = 0 ; i <= listeFilme.size()-1;i++){
        std::cout << "Thread: "<<listeFilme.at(i)<<std::endl;
        std::string film = listeFilme.at(i);
       // cv::VideoCapture cap(film);
      /*  if(!cap.isOpened()){
            std::cout << "Konnte den Film : " <<listeFilme.at(i)<<"nicht oeffnen"<<std::endl;
           return;*
        }

        while(1){
            cv::Mat frame;
            cap >> frame;
            if (frame.empty()){
                break;
            }
            cv::imshow("Frame",frame);
            cv::waitKey(10);

        }
        cap.release();*/



      /*  SDL_Texture *tmpPlayerTex= Texturemanager::loadTexture(listeFilme.at(i).c_str(),renderer);
        SDL_RenderClear(renderer);
        SDL_RenderCopy(renderer,tmpPlayerTex,NULL,&destRect);
        SDL_RenderPresent(renderer);*/

   }

    //cv::destroyWindow("Frame");

}



Kundendisplay::Kundendisplay()
{
    mWindow= nullptr;
    mRenderer=nullptr;
    exePath = SDL_GetBasePath();

    std::cout <<"Exe in Pfad:" << exePath<< std::endl;
    if (SDL_Init(SDL_INIT_EVERYTHING)){
        std::cout << "SDL initialisiert"<<std::endl;

    }else{
        std::cout<< "SDL Fehler :" << SDL_GetError()<<std::endl;
    }

    getMediaInfo();

}

Kundendisplay::~Kundendisplay()
{
    std::cout << "calling destructor Kundendisplay"<<std::endl;
}

void Kundendisplay::clearAll_SDL()
{
    SDL_DestroyRenderer(mRenderer);
    SDL_DestroyWindow(mWindow);
    SDL_Quit();
}

void Kundendisplay::handleEvents()
{
    SDL_Event myEvent;

    while(SDL_PollEvent(&myEvent)){

        if(myEvent.type ==  SDL_QUIT ){
            gameIsRunning=false;
            break;
        }

        if(myEvent.type == SDL_KEYDOWN ){
            std::cout << myEvent.key.keysym.sym<<std::endl;
            if(myEvent.key.keysym.sym == SDLK_ESCAPE){
                gameIsRunning=false;
                break;
            }
        }
    }

}

void Kundendisplay::update()
{



}

void Kundendisplay::render()
{

}

void Kundendisplay::createTheDisplay(const char *title, int xPos, int yPos, int width, int height, bool fullscreen)
{
    Uint32 modus;
    if(fullscreen){
        modus = SDL_WINDOW_FULLSCREEN;
    }else{
        modus = SDL_WINDOW_SHOWN;
    }
    mDestRect.h=height;
    mDestRect.w=width;
    mDestRect.x=0;
    mDestRect.y=0;
    mWindow =  SDL_CreateWindow(title,xPos,yPos,width,height,modus);
    if(mWindow == NULL){
        std::cout << "error building window" << SDL_GetError()<<std::endl;
        return;
    }
    mRenderer= SDL_CreateRenderer(mWindow,-1,0);
    if(mRenderer == NULL){
        std::cout << "error building renderer" << SDL_GetError()<<std::endl;
        return;
     }else{
        SDL_SetRenderDrawColor(mRenderer,0,0,0,255);
     }

}

void Kundendisplay::run()
{
    const int FPS = 100;
    const int frameDelay = 1000/FPS;
    Uint32 frameStart;
    int frameTime=0;
   // std::thread threadDiaShow(doSlideShow,listeBilder,mDestRect,mRenderer);
   // threadDiaShow.detach();

    std::thread threadFilmShow(doFilmShow,listeBilder,mDestRect,mRenderer);
    threadFilmShow.detach();

    int cnt = 0;
    while (gameIsRunning){
    cnt ++;
    std::cout << "gameIsRunning :" << cnt << std::endl;
       frameStart = SDL_GetTicks();
       handleEvents();
       //update();
       //render();
       frameTime = SDL_GetTicks()-frameStart;
       if(videoPlay){
           if(frameDelay > frameTime){
           SDL_Delay(frameDelay-frameTime);
           }
       }

    }


    clearAll_SDL();
}

 void Kundendisplay::getMediaInfo()
{
    listeBilder.clear();
    listeFilme.clear();
    //Pfad zur playlist
    char* p;
    int num_chars = asprintf(&p, "%sassets/Playlist.txt",exePath);
    //header fuer Listeneintraege
    char* vectorHeader;
    int tmpChars = asprintf(&vectorHeader, "%sassets/",exePath);

    std::ifstream file(p);
    std::string line;
    std::stringstream ss;
    std::string label="";
    std::string tmpStr="";
    std::cout <<"While"<<std::endl;
    while(std::getline(file,line)){
        std::cout <<"Playlist: " <<line<< std::endl;
        ss.str("");
        tmpStr="";
        if(line.substr(0,4).compare("Pic@")==0){
            std::cout <<"Label Bilder gefunden " <<std::endl;
            ss << vectorHeader<< line.substr(4,line.length());;
            tmpStr= ss.str();
            listeBilder.push_back(tmpStr);
        }else if (line.substr(0,4).compare("Mov@")==0){
            std::cout <<"Label Filme gefunden " <<std::endl;
            ss << vectorHeader << line.substr(4,line.length());
            tmpStr= ss.str();
            listeFilme.push_back(tmpStr);
        }

    }

    for (int i = 0 ; i <= listeBilder.size()-1;i++){
        std::cout <<"Bilder: " <<listeBilder.at(i)<<std::endl;
    }

}




































